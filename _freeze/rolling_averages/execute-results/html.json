{
  "hash": "b10fe4ad90d471f5cfa5ca8446979ea7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Calculating rolling averages\"\nauthor: \"Emma Cohn and Daniel Perez\"\nformat: html\neditor: visual\n---\n\n\n\n\nThis script will teach you how to calculate simple rolling averages using employment-to-population ratios (EPOPs). Note: this code will be updated soon to account for missing October 2025 CPS data.\n\n## Load required libraries\n\nThe following chunk of code loads the R libraries necessary for this exercise. You may need to install them to run this code. If you haven't yet set up your computer to run [EPI CPS microdata extracts](https://economic.github.io/earn_code_library/epi_microdata.html), complete that process before running this code.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Load necessary libraries\nlibrary(tidyverse)\nlibrary(epiextractr)\nlibrary(epidatatools)\nlibrary(realtalk)\nlibrary(labelled)\nlibrary(zoo)\nlibrary(openxlsx2)\n```\n:::\n\n\n\n\n## Import and clean data\n\n**Note:** Don't forget to **update years** to match your setup before running the script.\n\nRunning this script chunk will call the BLS Current Population Survey Basic data required to calculate rolling average EPOPs. It will also create a variable that will allow you to calculate prime-age EPOPs and set up some date formatting for the rolling average calculation later.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Import CPS ORG data\nbasic <- load_basic(2018:2024, \"year\", \"month\", \"basicwgt\", \"age\", \"wbhao\", \"selfinc\", \"emp\") |>\n  #Filter to working age population\n  filter(age >= 16) |> \n  # Create prime-age variable\n  mutate(prime_age = case_when(between(age, 25, 54) ~ 1, TRUE ~ 0)) |> \n  # Create population variable\n  mutate(pop = 1) |> \n  # Create date in yyyy-mm-dd format\n  mutate(date = ymd(paste0(year,'-', month,'-1'))) \n```\n:::\n\n\n\n\n## Calculate monthly rolling averages for EPOPs\n\nThis code chunk creates total 'employment' and 'population' counts, calculates the (prime-age) EPOP, sets up the rolling average, and applies an (optional) data suppression threshold. The suppression threshold is likely not necessary for national data, but it can become important at the state level or with narrow demographic cuts. Though there is no hard and fast rule for how large a sample needs to be, smaller samples will produce more noisy, less reliable data.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nepop_all <- basic |>\n  # Optional: filter to calculate prime-age EPOPS\n  filter(prime_age == 1) |> \n  # Total population and employment levels\n  summarise(total_pop = sum(pop * basicwgt, na.rm=TRUE),\n            total_emp = sum(emp * basicwgt, na.rm=TRUE),\n            n=n(),\n            .by=date) |>\n  # Calculate EPOP\n  mutate(epop = total_emp/total_pop) |> \n  # Order by date\n  arrange(date) |> \n# Calculate rolling average of previous 12 months for both EPOP and sample size\n  mutate(all_epop12 = rollmean(epop, k = 12, align = \"right\", fill = NA),\n         all_sample12 = rollsum(n, k = 12, align = \"right\", fill = NA)) |> \n  select(date, all_epop12, all_sample12) |>\n  # Suppress data with sample size of < 250\n  mutate(all_epop12 = if_else(is.na(all_sample12) | all_sample12 < 250,\n                            NA_real_, all_epop12))\n```\n:::\n\n\n\n\n### Calculate EPOPs by race/ethnicity and format output\n\nThis section adds code that breaks out EPOPs by race/ethnicity, using the `wbhao` variable. It also pivots the data so that each race/ethnicity group is its own column.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nepop_race <- basic |>\n  summarise(total_pop = sum(pop * basicwgt, na.rm=TRUE),\n            total_emp = sum(emp * basicwgt, na.rm=TRUE),\n            n=n(),\n            .by=c(wbhao, date)) |>\n  mutate(epop = total_emp/total_pop,\n         race = to_factor(wbhao)) |> \n  # Ensure correct order within each racial/ethnic category\n  arrange(race, date) |>  \n  # Compute rolling mean per 'race' group\n  group_by(race) |>       \n  mutate(epop12 = rollmean(epop, k = 12, align = \"right\", fill = NA),\n         sample12 = rollsum(n, k = 12, align = \"right\", fill = NA)) |> \n  ungroup() |> \n  select(date, race, epop12, sample12) |>\n  # Pivot the data to display each race/ethnicity as its own column with appropriate label (EPOP or sample size count)\n  pivot_wider(\n    names_from = race,\n    values_from = c(epop12, sample12),\n    names_glue = \"{race}_{.value}\"\n  )\n```\n:::\n\n\n\n\n## Export your data to a downloadable Excel\n\nUse `openxlsx2` to create a downloadable Excel. Don't forget to **edit the file path** to ensure it saves to the right location.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#  Export epop tables to one workbook \nwb <- wb_workbook()\n\nwb$ \n  # Add worksheet\n  add_worksheet(sheet = \"US EPOPs\")$\n  add_data(x = epop_all)$\n  add_worksheet(sheet = \"EPOPs by race\")$\n  add_data(x = epop_race)\n\nwb_save(wb, file = \"output/epop_tables.xlsx\", overwrite = TRUE)\n```\n:::\n\n\n\n\nAnd that's it! You can benchmark your data to the [State of Working America Data Library](https://data.epi.org/labor_force/labor_force_emp/line/month/national/percent_emp_12_month/overall?timeStart=1976-12-01&timeEnd=2025-12-01&dateString=2024-11-01&highlightedLines=overall) before filtering to specific states or demographic cuts to ensure reliability. As always, be sure to keep an eye on those sample sizes!",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}